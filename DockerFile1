# Base image for SonarQube Scanner
FROM maven:3.9.6-openjdk-11-slim AS sonarqube

# Install SonarQube Scanner
RUN apt-get update && \
    apt-get install -y unzip && \
    wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip && \
    unzip sonar-scanner-cli-4.6.2.2472-linux.zip && \
    rm sonar-scanner-cli-4.6.2.2472-linux.zip
ENV PATH="/sonar-scanner-cli-4.6.2.2472-linux/bin:${PATH}"

# Base image for Nexus
FROM sonatype/nexus3:3.67.1 AS nexus

# Configure Nexus (if necessary)
# Example:
# COPY nexus_config.yml /nexus-data/etc/nexus-default.properties

# Main build stage
FROM maven:3.9.6-openjdk-11-slim AS build

# Copy the source code
WORKDIR /app
COPY . .

# Build the application
RUN mvn clean package

# Test with SonarQube scanner
COPY --from=sonarqube /sonar-scanner-cli-4.6.2.2472-linux /sonar-scanner-cli-4.6.2.2472-linux
RUN sonar-scanner -Dsonar.host.url=http://sonarqube:9000 -Dsonar.projectKey=myProjectKey

# Deploy to Nexus (Replace with appropriate deployment command)
COPY --from=nexus /nexus-data /nexus-data
RUN mvn deploy:deploy-file -Durl=http://nexus:8081/repository/maven-releases/ -Dfile=target/*.war -DgroupId=<group-id> -DartifactId=<artifact-id> -Dversion=<version> -Dpackaging=war

# Deploy to Tomcat
FROM tomcat:8.0.20-jre8 AS deploy
RUN mv /usr/local/tomcat/webapps /usr/local/tomcat/webapps2
RUN mv /usr/local/tomcat/webapps.dist /usr/local/tomcat/webapps
COPY --from=build /app/target/*.war /usr/local/tomcat/webapps
